name: Run Space Weather Alert

on:
  schedule:
    - cron: '0 * * * *'   # каждый час
    - cron: '40 * * * *'  # в 40-й минуте каждого часа
  workflow_dispatch:

jobs:
  run-r-script:
    runs-on: ubuntu-latest

    env:
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
    - name: Клонирование репозитория
      uses: actions/checkout@v3

    - name: Установка R
      uses: r-lib/actions/setup-r@v2

    - name: Установка системных библиотек
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential pkg-config \
          libcurl4-openssl-dev libssl-dev libxml2-dev \
          libudunits2-dev libgdal-dev libgeos-dev libproj-dev \
          libfontconfig1-dev

    - name: Кэширование библиотек R
      uses: actions/cache@v3
      with:
        path: ~/R/Library
        key: ${{ runner.os }}-r-${{ hashFiles('**/*.R') }}
        restore-keys: |
          ${{ runner.os }}-r-

    - name: Установка зависимостей
      run: |
        mkdir -p ~/R/Library
        export R_LIBS_USER=~/R/Library
        Rscript requirements.R

    - name: Запуск главного скрипта
      run: |
        Rscript scripts/main.R
